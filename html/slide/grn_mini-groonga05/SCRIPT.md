30枚 / 15分 なので 1枚30秒が目安

# 0 : grn_mini
- こんにちは、おんがえしと申します。
- 今日は私が作っているgrn_miniというライブラリについて紹介させて下さい。

# 1 : 自己紹介
- はじめに自己紹介です
- GroongaやRroongaを使って色々なアプリケーションを開発しています
- 最近作ったものですと、ソースコード検索エンジンのMilkodeや、電子書籍検索エンジンのHonyomiがあります

# 2: 色々と作った結果として・・
- 色々作った結果として、Rroongaは超便利です
- 検索がとても速いのと、他のストレージエンジンが不要で使えるのがとてもいいです
- その反面、少しだけ使う時に苦労する部分も分かってきました

# 3: Rroongaの大変な所 - カラム設定
- 1つ目はカラムの設定です
- Rubyのデータ型に対応するGroongaのカラム型をリファレンスを引きながら調べる必要があります
- Groongaは他のテーブルを参照したりベクタ型を持つことも可能なのですが、それらをどうやって追加するかも調べる必要があります

# 4: Rroongaの大変な所 - インデックス設定
- 2つ目は全文検索用のインデックスの設定です
- 全文検索を行うカラムには別途語彙テーブルを作成する必要があります
- その際、テーブルの種類を何にするか、正規化はするのか、トークナイザーは何にするのか、など設定項目がたくさんあって複雑です

# 5: もっと気軽に
- 出来たら使い始めの時は出来るだけ簡単に、
- 慣れてきたら細かく設定を調整するように形にしたい所です
- 可能であればRubyのArrayやHash位簡単に使えるようにしたいと考えました

# 6: grn_miniを作ってみた
- そこで、grn_miniというライブラリを開発することにしました
- Rroongaにテーブル構築を自動化する薄いラッパーを被せたものです
- いざとなれば生のRroongaオブジェクトも簡単に取り出せるようにしました
- RubyGemsの形で提供しています

# 7: インストール
- インストールにはRroongaが必要です
- ラングバのページに詳しいインストール方法が載っていますので参考にして下さい
- インストールが上手くいかない時はGroongaパッケージを別途インストールするとよいかもしれません
- Rroongaのインストールに成功すればgrn_mini自体はPureRubyなので簡単にインストール出来ます

# 8: 使い方
- それでは実際の使い方をみてみましょう

# 9: データベースの初期化orロード
- まずはインストールした'grn_mini'をrequireします
- GrnMin::create_or_open()でデータベースファイル名を指定すると、無い時は新規にデータベースを作成し、ある時はロードします

# 10: GrnMini::Arrayの作成
- データベースのロードが終わったらテーブルを作成します
- まずはインデックスで参照出来るGrnMini::Arrayを使ってみます
- Arrayの作成には普通のArrayと同じようにnewするだけです
- 通常のRroongaと違いテーブル定義は不要です

# 11: 要素の追加
- GrnMini::Arrayは最初の1つ目のデータが追加された時に自動でテーブル定義を作成します
- 渡されたHash値の、キーがカラム名に、値がデータ型になります
- スライドの例ですと、textカラムは文字列、numberカラムは整数型になります
- さらに、渡されたデータが文字列の場合は全文検索用のインデックスも自動で貼ってくれます
- つまり(スライド戻す) Array.new して、(スライド進める) データを追加するだけで全文検索の準備が完了しているのです
- ちょっと使えそうな感じになってきたのではないでしょうか？

# 12: 要素の参照
- データの追加が終わった後は普通のRroongaの使い勝手と変わりません
- というか、要素の参照、書き換え、検索に関しては素のRroongaで充分に使いやすいです
- GrnMini::Arrayはインデックスが1から始まることに注意してください

# 13: 検索
- 追加したデータはGroongaのクエリー構文を使って高速に検索することが出来ます
- selectが検索用のメソッドです
- "test:@aa"はtextカラムにaaを含むものを見つけろ、という意味です
- クエリー構文の詳しい使い方はリンク先の7.11.1.クエリー構文をどうぞ

# 14: 生のRroongaオブジェクトを得る
- ちなみに、生のRroongaオブジェクトを得るには#grnメソッドを使います
- GrnMini::Arrayの場合はGroonga::Arrayが返ってきます

# 15: Hashの作成
- インデックスの代わりに文字列をキーにして参照出来るGrnMini::Hashも作成することが可能です
- 使い方はRubyのHashと大体同じです
- GrnMini::Hash.newでデータを生成し、
- 最初の1つ目のデータ追加時にカラム種類が確定します
- データの参照や、書き換えもRubyのHashと同じ感覚で使えます

# 16: まとめ
- ここで一度まとめます
- GrnMiniを使うとGroongaのArrayやHashをRuby標準のものと同じ感覚で使えます
- GroongaのArrayやHashは検索速度が標準のものと比べてとても速いです
- 追加したデータは自動的にデータベースファイルに永続化されます
- 検索の高速な簡易ストレージとして使える

# 17: 応用編
- 続きまして、基本機能以外のお得情報を紹介したいと思います

# 18: tmpdb
- まずはGrnMini::tmpdbです
- ブロックで囲むことで一時的なデータベースファイルを作り、抜けた時に自動で削除してくれます
- Groongaを使って実験する時にとても重宝します
- ブロックの中で生のRroonga関数を使うことも出来ます

# 19: 明示的にカラムを指定する
- 次にsetup_columnsメソッドです
- データを追加する前にテーブル定義を行うことが出来ます
- データベース内にテーブルが1つしか無い場合は基本不要ですが
- 複数テーブル間で参照し合ったり
- テーブル内に全てのデータが設定しないカラムが存在する時などに使います

# 20: 複数テーブルの連携
- ここでsetup_columnsを使った複数テーブルの連携についてご紹介したいと思います
- 例として簡単なブログシステムを考えてみます
- 複数テーブルを使う場合、newの引数にテーブル名を指定して作成します
- 今まで紹介した引数を省略した時はデフォルトのテーブル名で作成しています
- GrnMini::Arrayの時は"Array"、Hashの時は"Hash"という名前で作成しています
- 複数テーブルの連携に戻ります
- まずnewで作成したテーブルをローカル変数で受けておきます
- そしてsetup_columnsで、テーブル参照したいカラムのハッシュの値にテーブルを直接渡します
- たとえばarticlesのsetup_columnsでauthorカラムにusersを直接渡します
- これでArticlesテーブルのauthorカラムはUsersテーブルを持つことが出来るようになります

# 21: 複数テーブルの連携(2)
- カラム定義が終わったのでデータを追加していきます
- Usersテーブルはnameカラムだけなので普通に追加します
- ArticlesカラムはauthorカラムにUsersテーブルのデータを、textカラムに記事の内容を追加します
- これで全文検索の準備は整いました

# 22: 複数テーブルの連携(3)
- 著者がMr.Aで本文に'1'を含む記事は以下のような検索クエリで求めることが出来ます
- articles.selectの "author.name:MrA text:@1" です
- これで著者がMr.Aで記事に1を含むarticles["aaa:1"]を取得することが出来ます

# 23: もっと知りたい
- さらに詳しいサンプルコードはgithubのREADMEに置いてありますので是非参考にしてください
- 複雑な検索・・といった検索エンジンに必要な一通りの機能は紹介してあります

# 24: grn_miniのメリット
- 最後にgrn_miniを使うメリットについて紹介したいと思います
- これはそのままRroongaを使うメリットにもなると考えています

# 25: Rubyのライブラリで取得出来るものだったら何でも全文検索出来る
- 最大のメリットは「Rubyのライブラリで取得出来るものだったら何でも全文検索出来る」ということです

# 26: grn_miniで気軽に全文検索
- Rubyにはすでに豊富なライブラリがあり、Twitterのタイムラインを取得する、GitHubのログを取得するといったライブラリやサンプルコードがたくさんありつす
- これらのデータを集積して検索や解析したり、Webアプリケーションとして共有するのにgrn_miniとRroongaはうってつけではないかと考えています
- grn_miniとRubyのライブラリを組み合わせて色々と遊んでみてください
- grn_miniが使われた便利なアプリケーションやライブラリが生まれたらこんなに嬉しいことはありません

# 27: ありがとうございました
- ご清聴ありがとうございました

